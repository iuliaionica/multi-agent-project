# Vault AWS MCP Server

MCP Server for AWS operations with secure credential management through HashiCorp Vault.

## Multi-Agent System

The project includes an orchestrated agent system:

| Agent | Responsibilities |
|-------|------------------|
| **Orchestrator** | Coordinates agents, executes parallel workflows |
| **AWS Agent** | S3, EC2, Lambda, DynamoDB operations, etc. |
| **Vault Agent** | Secrets and credentials management |
| **MCP Agent** | MCP server management and tool discovery |
| **GitHub Agent** | Git operations (status, commit, push, pull, branch) |

### Interactive CLI

```bash
python cli.py
```

Commands: `/switch <agent>`, `/status`, `/help`, `/quit`

### Agent Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Orchestrator                             │
│              (coordinates all specialized agents)                │
└─────────────────────────────────────────────────────────────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
    ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐
    │   AWS   │   │  Vault  │   │   MCP   │   │ GitHub  │
    │  Agent  │   │  Agent  │   │  Agent  │   │  Agent  │
    └─────────┘   └─────────┘   └─────────┘   └─────────┘
         │              │              │              │
         ▼              ▼              ▼              ▼
    S3, EC2,      Secrets,       MCP Tools     Git ops,
    Lambda...     Credentials    Discovery     Push/Pull
```

## MCP Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                       MCP Client (Claude)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      MCP Server                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  S3 Tools   │  │ EC2 Tools   │  │  Generic AWS Tools      │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│                           │                                      │
│                           ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              AWS Session Manager                            ││
│  └─────────────────────────────────────────────────────────────┘│
│                           │                                      │
│                           ▼                                      │
│  ┌──────────────────┐  ┌──────────────────────────────────────┐ │
│  │  Vault Client    │  │       Lease Manager                  │ │
│  └──────────────────┘  └──────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    HashiCorp Vault                              │
│              (AWS Secrets Engine + STS AssumeRole)              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         AWS STS                                  │
│                 (AssumeRole → temp credentials)                  │
└─────────────────────────────────────────────────────────────────┘
```

## Security Flow

1. **MCP Server requests credentials from Vault** (not raw credentials)
2. **Vault communicates with AWS STS** and performs AssumeRole
3. **Vault returns a temporary token:**
   - Dynamically generated by AWS STS
   - Expires automatically (default TTL 1h)
   - Never exposes root credentials
   - Vault can revoke the token before expiration

## Installation

```bash
cd vault-aws-mcp
pip install -e .
```

## Vault Configuration

### 1. Start Vault

```bash
# Terminal 1 - Start Vault Server
vault server -config=$HOME/vault/config.hcl

# Terminal 2 - Setup environment
export VAULT_ADDR='http://127.0.0.1:8200'
vault operator unseal <unseal-key>
export VAULT_TOKEN='hvs.<token>'
```

### 2. Configure AWS Secrets Engine

```bash
# Enable AWS secrets engine
vault secrets enable aws

# Configure root credentials (for Vault to generate credentials)
vault write aws/config/root \
    access_key=$AWS_ACCESS_KEY_ID \
    secret_key=$AWS_SECRET_ACCESS_KEY \
    region=us-east-1

# Create IAM role for agents
vault write aws/roles/mcp-agent-role \
    credential_type=assumed_role \
    role_arns=arn:aws:iam::ACCOUNT_ID:role/VaultMCPAgentRole \
    default_sts_ttl=1h \
    max_sts_ttl=4h
```

### 3. Create IAM Role in AWS

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT_ID:user/vault-user"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

## Claude Code Configuration

Add to `~/.claude/settings.json`:

```json
{
  "mcpServers": {
    "vault-aws": {
      "command": "python",
      "args": ["-m", "vault_aws_mcp.server"],
      "cwd": "/path/to/vault-aws-mcp/src",
      "env": {
        "VAULT_AWS_MCP_VAULT_ADDR": "http://127.0.0.1:8200",
        "VAULT_AWS_MCP_VAULT_TOKEN": "hvs.your-token",
        "VAULT_AWS_MCP_VAULT_AWS_ROLE": "mcp-agent-role"
      }
    }
  }
}
```

## Available Tools

### S3
- `s3_list_buckets` - List all buckets
- `s3_list_objects` - List objects in a bucket
- `s3_get_object` - Download object content
- `s3_put_object` - Upload content to an object
- `s3_delete_object` - Delete an object
- `s3_get_bucket_info` - Get bucket information

### EC2
- `ec2_list_instances` - List EC2 instances
- `ec2_get_instance` - Get instance details
- `ec2_start_instance` - Start an instance
- `ec2_stop_instance` - Stop an instance
- `ec2_list_security_groups` - List security groups
- `ec2_list_vpcs` - List VPCs

### Generic AWS
- `aws_call` - Call any AWS API (DynamoDB, Lambda, SQS, etc.)
- `aws_get_caller_identity` - Check current identity
- `aws_list_regions` - List AWS regions

### Vault Credentials
- `vault_credential_status` - Current credentials status
- `vault_refresh_credentials` - Refresh credentials
- `vault_revoke_credentials` - Revoke credentials immediately

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `VAULT_AWS_MCP_VAULT_ADDR` | `http://127.0.0.1:8200` | Vault address |
| `VAULT_AWS_MCP_VAULT_TOKEN` | - | Vault authentication token |
| `VAULT_AWS_MCP_VAULT_AWS_MOUNT_PATH` | `aws` | AWS secrets engine mount path |
| `VAULT_AWS_MCP_VAULT_AWS_ROLE` | `mcp-agent-role` | Vault role for credentials |
| `VAULT_AWS_MCP_AWS_REGION` | `us-east-1` | Default AWS region |
| `VAULT_AWS_MCP_LEASE_TTL` | `1h` | Credentials TTL |
| `VAULT_AWS_MCP_LEASE_AUTO_RENEW` | `true` | Auto-renewal for leases |

## Development

```bash
# Install dev dependencies
pip install -e ".[dev]"

# Run tests
pytest

# Format code
black src/
ruff check src/
```
